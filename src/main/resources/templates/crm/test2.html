<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JsSIP WebRTC Phone</title>
    <script th:src="@{/js/jssip-3.10.0.js}"></script>
</head>
<body>
<h1>JsSIP 이용 WEBRTC 만들어보기 Ver.2</h1>
<P>
    현재 문제 점 <br>
    1. 전화 받기가 가능하지 않다 <br>
    2. 음성 입력 장치와, 출력 장치를 나눠서 제어할 수 있게 해야 함.<br>
</P>

<figure>
    <figcaption>숲의 소리를 들어보세요.</figcaption>
    <audio controls disableRemotePlayback th:src="@{/audio/forest.mp3}">브라우저가 오디오를 지원하지 않습니다.</audio>
</figure>
<p>
    <cite>
        <a href="https://freesound.org/people/reinsamba/sounds/18765/" target="_parent"> evening in the forest.wav </a>
    </cite>
    by reinsamba, cropped and converted to mp3.
</p>

<!-- 로그인 폼 -->
<form id="loginForm">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" required><br>
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required><br>
    <button type="submit">Login</button>
</form>

<!-- 통화 컨트롤 -->
<div id="callControls" style="display:none;">
    <button id="callButton">Call</button>
    <button id="hangupButton" style="display:none;">Hang Up</button>
</div>

<!-- 오디오 장치 선택 -->
<label for="audioSource">Microphone:</label>
<select id="audioSource"></select>

<label for="audioOutput">Speaker:</label>
<select id="audioOutput"></select>

<!-- 오디오 장치 적용 버튼 -->
<button id="applyAudioSettings">Apply Audio Settings</button>

<!-- 통화 상태 표시 -->
<div id="callStatus"></div>

<!-- 오디오 출력 -->
<audio id="remoteAudio" autoplay></audio>

<script>
    let ua; // User Agent 객체
    let session; // 통화 세션 객체
    let localStream; // 로컬 미디어 스트림 객체

    // 모든 오디오 장치 나열
    navigator.mediaDevices.enumerateDevices().then(devices => {
        const audioInputSelect = document.getElementById('audioSource');
        const audioOutputSelect = document.getElementById('audioOutput');

        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Device ${audioInputSelect.length + 1}`;

            if (device.kind === 'audioinput') {
                audioInputSelect.appendChild(option);
            } else if (device.kind === 'audiooutput') {
                audioOutputSelect.appendChild(option);
            }
        });
    });

    // 로그인 폼 제출 시 이벤트 핸들러
    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault(); // 폼 기본 제출 동작 방지
        const username = document.getElementById('username').value; // 사용자 이름 가져오기
        const password = document.getElementById('password').value; // 비밀번호 가져오기

        // WebSocket 인터페이스 생성
        const socket = new JsSIP.WebSocketInterface('wss://www.praymyk.co.kr:8089/ws');
        const configuration = {
            sockets: [socket], // 소켓 설정
            uri: 'sip:' + username + '@www.praymyk.co.kr', // SIP URI 설정
            password: password, // 비밀번호 설정
            realm: 'www.praymyk.co.kr', // Realm 설정
            display_name: username, // 표시 이름 설정
            register: true // 자동 등록 설정
        };

        ua = new JsSIP.UA(configuration); // User Agent 생성
        ua.start(); // User Agent 시작

        // 등록 성공 시 이벤트 핸들러
        ua.on('registered', () => {
            console.log('User Agent registered successfully');
            document.getElementById('callControls').style.display = 'block'; // 통화 컨트롤 표시
        });

        // 등록 실패 시 이벤트 핸들러
        ua.on('registrationFailed', (data) => {
            console.error('User Agent registration failed', data.cause);
        });

        // 새로운 RTC 세션(통화) 발생 시 이벤트 핸들러
        ua.on('newRTCSession', (data) => {
            session = data.session; // 세션 객체 저장
            if (session.direction === 'incoming') { // 수신 통화인 경우
                applyAudioSettings().then(stream => {
                    localStream = stream;
                    session.connection.addStream(stream); // 사용자의 오디오 스트림을 추가
                    session.answer({ mediaConstraints: { audio: true, video: false }}); // 통화 수락
                    document.getElementById('callButton').style.display = 'none';
                    document.getElementById('hangupButton').style.display = 'block';
                }).catch(error => {
                    console.error('Error accessing media devices.', error);
                });

                session.connection.addEventListener('addstream', (event) => {
                    const remoteAudio = document.getElementById('remoteAudio');
                    remoteAudio.srcObject = event.stream; // Asterisk로부터 받은 오디오 스트림을 출력 장치에 연결
                    setAudioOutput(remoteAudio);
                });
            }

            // 통화 종료 시 이벤트 핸들러
            session.on('ended', () => {
                document.getElementById('hangupButton').style.display = 'none';
                document.getElementById('callButton').style.display = 'block';
            });

            // 통화 실패 시 이벤트 핸들러
            session.on('failed', (e) => {
                console.error('Call failed: ', e);
            });

            // 통화 확인 시 이벤트 핸들러
            session.on('confirmed', () => {
                console.log('Call confirmed');
            });
        });
    });

    // 통화 버튼 클릭 시 이벤트 핸들러
    document.getElementById('callButton').addEventListener('click', function() {
        const target = prompt("Enter the SIP address to call:"); // 통화할 SIP 주소 입력 받기
        const eventHandlers = {
            'progress': function(e) {
                console.log('call is in progress');
            },
            'failed': function(e) {
                console.log('call failed with cause: ' + e.cause);
            },
            'ended': function(e) {
                console.log('call ended with cause: ' + e.cause);
                document.getElementById('hangupButton').style.display = 'none';
                document.getElementById('callButton').style.display = 'block';
            },
            'confirmed': function(e) {
                console.log('call confirmed');
            }
        };

        // 통화 옵션 설정
        applyAudioSettings().then(stream => {
            localStream = stream;
            const options = {
                eventHandlers: eventHandlers,
                mediaStream: stream, // 사용자의 오디오 스트림을 추가
                mediaConstraints: { audio: true, video: false } // 미디어 제약 조건 설정
            };

            session = ua.call('sip:' + target + '@www.praymyk.co.kr', options); // 통화 시작
            document.getElementById('callButton').style.display = 'none';
            document.getElementById('hangupButton').style.display = 'block';

            session.connection.addEventListener('addstream', (event) => {
                const remoteAudio = document.getElementById('remoteAudio');
                remoteAudio.srcObject = event.stream; // Asterisk로부터 받은 오디오 스트림을 출력 장치에 연결
                setAudioOutput(remoteAudio);
            });
        }).catch(error => {
            console.error('Error accessing media devices.', error);
        });
    });

    // 통화 종료 버튼 클릭 시 이벤트 핸들러
    document.getElementById('hangupButton').addEventListener('click', function() {
        if (session) {
            session.terminate(); // 통화 종료
        }
    });

    // 선택한 오디오 장치로 미디어 스트림 가져오기
    function getUserMedia() {
        const audioSource = document.getElementById('audioSource').value;
        const constraints = {
            audio: {
                deviceId: audioSource ? { exact: audioSource } : undefined // 오디오 입력 장치를 지정
            },
            video: false
        };

        return navigator.mediaDevices.getUserMedia(constraints);
    }

    // 선택한 오디오 출력 장치 설정
    function setAudioOutput(element) {
        const audioOutput = document.getElementById('audioOutput').value;
        if (typeof element.sinkId !== 'undefined') {
            element.setSinkId(audioOutput).then(() => {
                console.log(`Success, audio output device attached: ${audioOutput}`);
            }).catch(error => {
                console.error('Error setting audio output device: ', error);
            });
        } else {
            console.warn('Browser does not support output device selection.');
        }
    }

    // 오디오 설정 적용 버튼 클릭 시 이벤트 핸들러
    document.getElementById('applyAudioSettings').addEventListener('click', function() {
        applyAudioSettings().then(stream => {
            localStream = stream;
            console.log('Audio settings applied.');
        }).catch(error => {
            console.error('Error applying audio settings.', error);
        });
    });

    // 오디오 설정 적용 함수
    function applyAudioSettings() {
        return getUserMedia().then(stream => {
            // 로컬 오디오 스트림을 사용할 수 있습니다.
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            localStream = stream;
            console.log('Local stream set.');
            return stream;
        });
    }
</script>
</body>
</html>
