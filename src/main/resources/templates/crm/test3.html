<!DOCTYPE html>
<html>
<head>
    <title>WebRTC 구현 ver.4</title>
    <script th:src="@{/js/jssip-3.10.0.js}"></script>
</head>
<body>
<h1>WebRTC ver.4</h1>

<div id="login-form">
    <label for="sipUri">내선번호 :</label>
    <input type="text" id="sipUri" placeholder="내선번호 입력">
    <br>
    <label for="sipPassword">비번:</label>
    <input type="password" id="sipPassword">
    <br>
    <button id="loginButton">Login</button>
</div>

<div id="phone-controls" style="display:none;">
    <button id="callButton">전화걸기</button> <!-- 전화 걸기 버튼 -->
    <button id="hangupButton">끊기</button> <!-- 전화 끊기 버튼 -->
    <div id="status"></div> <!-- 상태 메시지 표시 -->
    <div id="callTime">통화 시간: 00:00:00</div> <!-- 통화 시간 표시 -->
</div>

<audio id="remoteAudio"></audio> <!-- 원격 오디오 재생을 위한 오디오 태그 -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var ua; // User Agent 변수 선언
        var session; // 통화 세션 변수 선언
        var callStartTime; // 통화 시작 시간 변수 선언
        var callTimer; // 통화 타이머 변수 선언
        var domain = 'www.praymyk.co.kr'; // 기본 도메인 설정

        // SIP URI를 포맷하여 도메인을 자동으로 추가하는 함수
        function formatSipUri(username) {
            if (!username.includes('@')) {
                return 'sip:' + username + '@' + domain;
            }
            return username;
        }

        // 통화 타이머를 시작하는 함수
        function startCallTimer() {
            callStartTime = new Date(); // 통화 시작 시간 기록
            callTimer = setInterval(updateCallTime, 1000); // 1초마다 updateCallTime 함수 호출
        }

        // 통화 시간을 업데이트하는 함수
        function updateCallTime() {
            var now = new Date();
            var elapsed = new Date(now - callStartTime); // 경과 시간 계산
            var hours = String(elapsed.getUTCHours()).padStart(2, '0');
            var minutes = String(elapsed.getUTCMinutes()).padStart(2, '0');
            var seconds = String(elapsed.getUTCSeconds()).padStart(2, '0');
            document.getElementById('callTime').textContent = `Call Time: ${hours}:${minutes}:${seconds}`; // 통화 시간 표시 업데이트
        }

        // 통화 타이머를 중지하는 함수
        function stopCallTimer() {
            clearInterval(callTimer); // 타이머 중지
            document.getElementById('callTime').textContent = 'Call Time: 00:00:00'; // 통화 시간 초기화
        }

        // 로그인 버튼 클릭 이벤트 핸들러
        document.getElementById('loginButton').addEventListener('click', function () {
            var sipUriInput = document.getElementById('sipUri').value;
            var sipPassword = document.getElementById('sipPassword').value;
            var sipUri = formatSipUri(sipUriInput); // SIP URI 포맷

            var socket = new JsSIP.WebSocketInterface('wss://www.praymyk.co.kr:8089/ws'); // WebSocket 인터페이스 설정
            var configuration = {
                sockets: [socket],
                uri: sipUri,
                password: sipPassword,
                session_timers: false
            };

            ua = new JsSIP.UA(configuration); // User Agent 인스턴스 생성

            ua.start(); // User Agent 시작

            // 등록 실패 이벤트 핸들러
            ua.on('registrationFailed', function (ev) {
                console.log('Registration failed:', ev.cause);
                document.getElementById('status').textContent = 'Registration failed: ' + ev.cause; // 등록 실패 시 상태 메시지 업데이트
            });

            // 등록 성공 이벤트 핸들러
            ua.on('registered', function () {
                console.log('Registered successfully');
                document.getElementById('status').textContent = 'Registered successfully'; // 등록 성공 시 상태 메시지 업데이트
                document.getElementById('login-form').style.display = 'none'; // 로그인 폼 숨기기
                document.getElementById('phone-controls').style.display = 'block'; // 전화 제어 버튼 표시
            });

            // 새로운 RTC 세션 이벤트 핸들러
            ua.on('newRTCSession', function (ev) {
                session = ev.session; // 새 RTC 세션 생성

                if (session.direction === 'incoming') { // 수신 전화일 경우
                    var caller = session.remote_identity.uri.toString();
                    if (confirm("전화온 내선 : " + caller)) {
                        session.answer(); // 수신 전화에 대해 사용자가 수락하면 세션을 수락
                        document.getElementById('status').textContent = 'Incoming call from: ' + caller; // 발신자 주소 상태 메시지에 표시
                    } else {
                        session.terminate(); // 수신 전화에 대해 사용자가 거절하면 세션을 종료
                    }
                }

                // 통화 수락 이벤트 핸들러
                session.on('accepted', function () {
                    console.log('Call accepted');
                    document.getElementById('status').textContent = 'Call accepted'; // 통화 수락 시 상태 메시지 업데이트
                    startCallTimer(); // 통화 타이머 시작
                });

                // 통화 종료 이벤트 핸들러
                session.on('ended', function () {
                    console.log('Call ended');
                    document.getElementById('status').textContent = 'Call ended'; // 통화 종료 시 상태 메시지 업데이트
                    stopCallTimer(); // 통화 타이머 중지
                });

                // 통화 실패 이벤트 핸들러
                session.on('failed', function (ev) {
                    console.log('Call failed:', ev.cause);
                    document.getElementById('status').textContent = 'Call failed: ' + ev.cause; // 통화 실패 시 상태 메시지 업데이트
                    stopCallTimer(); // 통화 타이머 중지
                });

                // 원격 오디오 스트림 이벤트 핸들러
                session.connection.addEventListener('addstream', function (event) {
                    var remoteAudio = document.getElementById('remoteAudio');
                    remoteAudio.srcObject = event.stream; // 원격 오디오 스트림 설정
                    remoteAudio.play(); // 원격 오디오 재생
                });

                // 전화 끊기 버튼 클릭 이벤트 핸들러
                document.getElementById('hangupButton').addEventListener('click', function () {
                    session.terminate(); // 전화 끊기 버튼 클릭 시 세션 종료
                });
            });
        });

        // 전화 걸기 버튼 클릭 이벤트 핸들러
        document.getElementById('callButton').addEventListener('click', function () {
            var eventHandlers = {
                'progress': function () {
                    console.log('Call is in progress'); // 통화 진행 중 로그
                },
                'failed': function (ev) {
                    console.log('Call failed with cause: ' + ev.cause);
                    document.getElementById('status').textContent = 'Call failed: ' + ev.cause; // 통화 실패 시 상태 메시지 업데이트
                    stopCallTimer(); // 통화 타이머 중지
                },
                'ended': function () {
                    console.log('Call ended with cause: ' + ev.cause); // 통화 종료 시 로그
                    stopCallTimer(); // 통화 타이머 중지
                },
                'confirmed': function () {
                    console.log('Call confirmed'); // 통화 확인 시 로그
                }
            };

            var options = {
                eventHandlers: eventHandlers,
                mediaConstraints: { audio: true, video: false } // 오디오만 허용하는 미디어 제약 조건
            };

            var targetInput = prompt("전화 걸 내선 입력 :"); // 사용자가 전화를 걸 SIP URI 입력
            var target = formatSipUri(targetInput); // SIP URI 포맷
            session = ua.call(target, options); // 전화 걸기

            // 통화 수락 이벤트 핸들러
            session.on('accepted', function () {
                console.log('Call accepted');
                document.getElementById('status').textContent = 'Call accepted'; // 통화 수락 시 상태 메시지 업데이트
                startCallTimer(); // 통화 타이머 시작
            });
        });
    });
</script>
</body>
</html>
