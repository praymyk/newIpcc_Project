<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담관리 - 실시간 현황</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- css 미리보기용 지정 -->
    <link rel="stylesheet" href="../../../static/css/crm/crm-callmanagement/cmg-content-a.css">

    <style>
        /* 전체 배경 및 폰트 설정 */
        body {
            background-color: #F9F9F9;
            font-family: 'San Francisco', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #333333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div class="cmg-content-a" th:fragment="cmg-content-a">

        <span>실시간 현황</span>
        <div class="cmg-call-stat-wrap">
            <div class="cmg-call-stat">
                <!-- 통화 상태 정보 -->
                <div class="call-stat-card">
                    <span class="call-stat-title">연결 대기 고객</span>
                    <span class="call-stat-number" id="waiting"></span>
                </div>
                <div class="call-stat-card">
                    <span class="call-stat-title">상담 가능(대기)</span>
                    <span class="call-stat-number" id="ready"></span>
                </div>
                <div class="call-stat-card">
                    <span class="call-stat-title">상담 중</span>
                    <span class="call-stat-number" id="busy"></span>
                </div>
                <div class="call-stat-card">
                    <span class="call-stat-title">포기 호</span>
                    <span class="call-stat-number" id="abandon">0</span>
                </div>
            </div>

            <div class="cmg-call-chart">
                <div class="myDonutChart-box">
                    <canvas id="myDonutChart"></canvas>
                </div>
                <div class="legend-container" id="legend"></div> <!-- 범례를 표시할 컨테이너 -->
            </div>

            <div class="agtInfo-container">
                <span>상담원 상태</span>
                <table>
                    <thead>
                        <tr>
                            <th class="sortable">상담사 명</th>
                            <th class="sortable">내선번호</th>
                            <th class="sortable">상태</th>
                            <th class="sortable">통화시간</th>
                            <th class="sortable">인</th>
                            <th class="sortable">아웃</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>김상담</td>
                            <td>1001</td>
                            <td>대기</td>
                            <td>02:15</td>
                            <td>5</td>
                            <td>3</td>
                        </tr>
                        <tr>
                            <td>나상담</td>
                            <td>2001</td>
                            <td>대기</td>
                            <td>03:15</td>
                            <td>7</td>
                            <td>2</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>



    <!-- 통화 상태 차트 -->
    <script>
    // Chart.js 설정 및 초기화
    const ctx = document.getElementById('myDonutChart').getContext('2d');

    // 여기에 값 불러 오기
    const dataValues = [10, 10, 10]; // 각 영역의 초기 값
    const labels = ['연결 대기 고객', '상담 가능(대기)', '상담 중']; // 라벨 이름
    const backgroundColors = ['#A3E3D8', '#FFE8AE', '#CBC4F2']; // 각 라벨의 색상

    const myDonutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: dataValues,
                backgroundColor: backgroundColors,
                borderColor: '#F9F9F9', // 도넛 사이의 경계선 색상 (배경색과 동일하게 설정)
                borderWidth: 4, // 경계선 너비
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
                legend: {
                    display: false // 기본 범례 숨김
                },
                tooltip: {
                    enabled: true,
                }
            }
        }
    });

    // 라벨 업데이트 함수
    function updateLabels(chart) {
        const data = chart.data.datasets[0].data;

        document.getElementById('waiting').textContent = `${data[0]}`;
        document.getElementById('ready').textContent = `${data[1]}`;
        document.getElementById('busy').textContent = `${data[2]}`;
    }

    // 사용자 정의 범례 생성
    function generateCustomLegend(chart) {
        const legendContainer = document.getElementById('legend');
        legendContainer.innerHTML = ''; // 기존 범례 제거

        const labels = chart.data.labels;
        const colors = chart.data.datasets[0].backgroundColor;
        const data = chart.data.datasets[0].data; // 데이터 값을 가져옴

        labels.forEach((label, index) => {
            const legendItem = document.createElement('div');
            legendItem.classList.add('legend-item');

            const colorBox = document.createElement('div');
            colorBox.classList.add('legend-color-box');
            colorBox.style.backgroundColor = colors[index];

            const labelText = document.createElement('span');
            labelText.classList.add('legend-label');
            labelText.textContent = `${label}: ${data[index]}`;  // 라벨과 데이터 값 함께 표시

            legendItem.appendChild(colorBox);
            legendItem.appendChild(labelText);
            legendContainer.appendChild(legendItem);
        });
    }

    // 초기 라벨 설정
    updateLabels(myDonutChart);

    // 사용자 정의 범례 생성
    generateCustomLegend(myDonutChart);

    // 차트 데이터를 주기적으로 업데이트하는 함수
    function updateChartData() {
        // 실제로는 서버에서 데이터를 가져와야 하지만, 여기서는 예시로 랜덤 데이터 사용
        const newData = [
            Math.floor(Math.random() * 100), 
            Math.floor(Math.random() * 100), 
            Math.floor(Math.random() * 100)
        ];

        // 차트 데이터 업데이트
        myDonutChart.data.datasets[0].data = newData;
        myDonutChart.update();

        // 업데이트된 데이터를 기반으로 라벨 갱신
        updateLabels(myDonutChart);

        // 범례를 새로 고침
        generateCustomLegend(myDonutChart);
    }

    // 5초마다 데이터 갱신
    setInterval(updateChartData, 5000);



    // 테이블 정렬 기능
    document.querySelectorAll('th.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const index = Array.prototype.indexOf.call(header.parentNode.children, header);
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isDescending = header.classList.contains('desc');
            
            // 다른 열의 정렬 상태 초기화
            table.querySelectorAll('th.sortable').forEach(th => th.classList.remove('desc'));

            // 행 정렬
            rows.sort((rowA, rowB) => {
                const cellA = rowA.children[index].innerText;
                const cellB = rowB.children[index].innerText;
                
                // 숫자 열의 경우 숫자로 변환
                const a = isNaN(cellA) ? cellA : parseFloat(cellA);
                const b = isNaN(cellB) ? cellB : parseFloat(cellB);

                if (a < b) return isDescending ? 1 : -1;
                if (a > b) return isDescending ? -1 : 1;
                return 0;
            });

            // 정렬된 행 추가
            rows.forEach(row => tbody.appendChild(row));

            // 정렬 상태 업데이트
            header.classList.toggle('desc', !isDescending);
        });
    });
    </script>
</body>
</html>
